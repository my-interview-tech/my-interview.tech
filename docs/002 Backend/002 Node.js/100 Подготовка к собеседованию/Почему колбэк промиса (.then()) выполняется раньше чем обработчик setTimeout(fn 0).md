---
title: Почему колбэк промиса (.then()) выполняется раньше чем обработчик setTimeout(fn 0)
draft: false
tags:
  - "#NodeJS"
  - "#Promise"
  - "#then"
  - "#setTimeout"
  - "#EventLoop"
  - "#microtask"
  - "#macrotask"
info:
  - "[Документация Node.js по Event Loop](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/)"
  - "[MDN: Порядок операций в Event Loop](https://developer.mozilla.org/ru/docs/Web/JavaScript/EventLoop)"
  - "[Jake Archibald: In The Loop - JSConf.Asia](https://www.youtube.com/watch?v=cCOL7MC4Pl0)"
  - "[Разница между микро- и макрозадачами](https://nodejs.org/en/docs/guides/dont-block-the-event-loop/)"
---

Колбэк промиса `.then()` выполняется раньше, чем обработчик `setTimeout(fn, 0)`, из-за механизма **Event Loop** в JavaScript и разницы между **микрозадачами (Microtasks)** и **макрозадачами (Macrotasks)**.

**Разница между `.then()` и `setTimeout(fn, 0)`**

1. **Колбэк промиса (`.then()`) попадает в очередь микрозадач (Microtask Queue)**.
   - Микрозадачи включают:
     - Обработчики `.then()`, `.catch()`, `.finally()`.
     - Очередь `process.nextTick()` в Node.js.
     - Обработчики `MutationObserver` в браузере.
   - После выполнения основного кода (главного стека вызовов) **сначала выполняются все микрозадачи**.
2. **`setTimeout(fn, 0)` попадает в очередь макрозадач (Macrotask Queue)**.
   - Макрозадачи включают:
     - `setTimeout`, `setInterval`, `setImmediate` (в Node.js).
     - Обработчики I/O (например, чтение файла, сетевые запросы).
     - Обработчики UI-ивентов (например, `onclick`).
   - Макрозадачи выполняются **только после микрозадач**.

```javascript
console.log("Start")

setTimeout(() => {
  console.log("setTimeout")
}, 0)

Promise.resolve().then(() => {
  console.log("Promise")
})

console.log("End")
```

**Разбор выполнения:**

1. `"Start"` → выполняется немедленно (основной стек).
2. `setTimeout(fn, 0)` → помещается в очередь макрозадач.
3. `Promise.resolve().then(...)` → помещается в очередь микрозадач.
4. `"End"` → выполняется немедленно (основной стек завершён).
5. **Очередь микрозадач** выполняется первой: `"Promise"`.
6. **Очередь макрозадач** выполняется после: `"setTimeout"`.

**Вывод в консоли:**

```
Start
End
Promise
setTimeout
```

### Итог:

- Колбэки промисов (`.then()`) выполняются **раньше**, чем `setTimeout(fn, 0)`, потому что микрозадачи выполняются **до** обработки макрозадач.

---

[[002 Node.js|Назад]]
