---
title: Как оптимизировать размер node_modules в production
draft: false
tags:
  - "#NodeJS"
  - "#node_modules"
  - "#оптимизация"
  - "#production"
  - "#npm"
  - "#yarn"
  - "#docker"
info:
  - "[Документация npm по установке пакетов](https://docs.npmjs.com/cli/v7/commands/npm-install)"
  - "[Документация npm по управлению зависимостями](https://docs.npmjs.com/specifying-dependencies-and-devdependencies-in-a-package-json-file)"
  - "[Docker и Node.js](https://nodejs.org/en/docs/guides/nodejs-docker-webapp/)"
  - "[Yarn документация](https://yarnpkg.com/cli/install)"
---

Оптимизация размера **`node_modules`** для продакшн-среды важна для сокращения времени развертывания, использования памяти и минимизации размера конечного приложения. Вот несколько рекомендаций по уменьшению размера **`node_modules`** и оптимизации зависимостей для продакшн-среды:

### 1. **Использование `npm install --production`**

- Когда вы устанавливаете зависимости для продакшн-среды, можно использовать флаг **`--production`**:
  ```bash
  npm install --production
  ```
- Это установит только **продакшн-зависимости**, игнорируя **devDependencies** (например, тестовые и разработческие пакеты). Это позволит уменьшить размер **`node_modules`**, исключив ненужные пакеты, которые не требуются в продакшне.

### 2. **Удаление неиспользуемых зависимостей**

- Просмотрите список зависимостей и удалите все пакеты, которые больше не используются в проекте.
  - Чтобы найти неиспользуемые пакеты, можно использовать инструменты, такие как **`depcheck`** или **`npm-check`**.
  - Пример установки **`depcheck`**:
    ```bash
    npm install -g depcheck
    depcheck
    ```
- Эти инструменты помогут вам обнаружить зависимости, которые не используются в коде, и их можно удалить.

### 3. **Установка только необходимых зависимостей**

- Часто в проектах бывают установлены пакеты, которые не используются в продакшн-среде (например, для разработки или тестирования). Убедитесь, что только нужные зависимости установлены в **`dependencies`** в **`package.json`**, а все остальное перенесено в **`devDependencies`**.
  - Перенос пакетов из **`devDependencies`** в **`dependencies`** (если они нужны в продакшн-среде).
  - Перемещение пакетов из **`dependencies`** в **`devDependencies`** (если они нужны только для разработки).

### 4. **Использование `.npmignore` или `.gitignore`**

- Если ваш проект использует сторонние пакеты, которые содержат ненужные файлы (например, документацию или тесты), вы можете настроить **`.npmignore`** или **`.gitignore`**, чтобы исключить их при установке. Это особенно полезно при публикации собственного пакета.
  - Создайте или отредактируйте файл **`.npmignore`**, чтобы исключить ненужные файлы и папки.

### 5. **Уменьшение размера отдельных пакетов**

- Некоторые пакеты могут иметь тяжелые зависимости или большое количество файлов, которые не используются в вашем проекте. Чтобы уменьшить размер, вы можете:
  - **Tree-shaking** — использование инструментов для удаления неиспользуемого кода (например, для JavaScript-модулей).
  - **Bundle** — использовать такие сборщики, как **Webpack** или **Rollup**, для объединения и минимизации кода и зависимостей, удаляя неиспользуемые части.

### 6. **Использование Yarn вместо npm**

- **Yarn** может использовать **резолюцию зависимостей** более эффективно, что позволяет избежать установки пакетов, которые уже установлены на более высоком уровне. Он может создавать меньшие **`node_modules`** за счет использования более агрессивной дедупликации.
- Пример:
  ```bash
  yarn install --production
  ```

### 7. **Использование `npm prune`**

- **`npm prune`** удаляет неиспользуемые зависимости, которые были установлены, но больше не нужны. Это полезно после удаления зависимостей или при смене версий:
  ```bash
  npm prune --production
  ```

### 8. **Публикация собственных пакетов**

- Если ваш проект зависит от крупных пакетов, вы можете подумать о создании более легких, минимизированных версий этих пакетов.
- Публикуйте только необходимые части вашего кода, исключая ненужные файлы и зависимости.

### 9. **Использование альтернативных легких пакетов**

- В некоторых случаях можно заменить тяжелые зависимости на более легкие аналоги. Например, можно заменить библиотеки, которые содержат множество лишнего функционала, на более специализированные или минимизированные версии.

### 10. **Использование Docker**

- В продакшн-среде часто используют **Docker** для упаковки приложения. В таком случае можно использовать **многоступенчатую сборку Docker**, чтобы исключить лишние файлы из финального образа.
- Пример Dockerfile для продакшн-сборки:

  ```dockerfile
  # Стартовая стадия
  FROM node:14 AS build

  WORKDIR /app

  COPY package*.json ./
  RUN npm install --production

  COPY . .

  # Финальная стадия (только для продакшн)
  FROM node:14-slim

  WORKDIR /app

  COPY --from=build /app /app

  CMD ["node", "app.js"]
  ```

### Заключение:

Оптимизация размера **`node_modules`** для продакшн-среды требует тщательного контроля за зависимостями, исключения лишних пакетов и эффективного использования инструментов для управления зависимостями. Основные шаги включают:

- Установку зависимостей с флагом **`--production`**.
- Удаление неиспользуемых зависимостей.
- Использование инструментов для минимизации и дедупликации.
- Подготовку **Docker**-образов с учётом оптимизации зависимостей.

Эти шаги помогут уменьшить размер **`node_modules`** и улучшить производительность приложения в продакшн-среде.

---

[[002 Node.js|Назад]]
