---
title: Как Node.js обрабатывает асинхронные операции
draft: false
tags:
  - "#NodeJS"
  - "#асинхронность"
  - "#Event-Loop"
  - "#микрозадачи"
  - "#Таймеры"
info:
  - "[Документация Node.js - Event Loop](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/)"
  - "[Документация JavaScript - Асинхронное программирование](https://developer.mozilla.org/ru/docs/Learn/JavaScript/Asynchronous)"
  - "[Асинхронная модель Node.js](https://nodejs.org/en/guides/blocking-vs-non-blocking)"
---

Node.js обрабатывает асинхронные операции с использованием **Event Loop**, который позволяет выполнять операции **не блокируя основной поток выполнения**. Благодаря этому Node.js может эффективно обрабатывать большое количество одновременных запросов, таких как HTTP-запросы, операции с файлами и запросы к базам данных.

## Как работает обработка асинхронных операций в Node.js

1. **Асинхронные операции**: Асинхронные операции (например, чтение файла, запросы к базе данных, таймеры) в Node.js не блокируют выполнение кода. Вместо этого они передают выполнение другим задачам, оставляя обработку результата на потом.
2. **Event Loop (Цикл событий)**: Event Loop — это механизм, который обрабатывает асинхронные операции. Он проходит через несколько фаз, обеспечивая выполнение кода поочередно и эффективно.

## Фазы Event Loop

Event Loop проходит через несколько фаз, обрабатывая различные типы задач. Вот основные из них:

1. **Timers**:  
   На этой стадии выполняются задачи, отложенные с помощью `setTimeout()` и `setInterval()`. Если время истекло, то таймеры помещаются в очередь задач.
2. **I/O Callbacks**:  
   На этой фазе выполняются асинхронные колбэки для операций ввода-вывода (например, чтение файлов, запросы в базу данных, HTTP-запросы).
3. **Idle, Prepare**:  
   В этой фазе происходит подготовка к выполнению оставшихся операций. В основном она используется внутренними механизмами Node.js.
4. **Poll**:  
   Эта фаза проверяет очередь событий. Если есть колбэки, которые должны быть выполнены, они обрабатываются. В этой фазе могут блокировать операции, если не указано, что нужно завершить их асинхронно (например, события с файловыми дескрипторами).
5. **Check**:  
   Здесь выполняются колбэки, добавленные через `setImmediate()`.
6. **Close Callbacks**:  
   На этой стадии выполняются колбэки, такие как `socket.on('close', ...)`.

## Типы асинхронных операций

1. **Таймеры (`setTimeout`, `setInterval`)**: Асинхронные операции, которые помещаются в очередь **Timers** и выполняются после истечения заданного времени.
2. **Операции с файловой системой (FS)**: Например, `fs.readFile()`, `fs.writeFile()` — эти операции не блокируют выполнение кода, а результат будет передан в колбэк после завершения операции.
3. **Промисы**: Промисы выполняются через **микрозадачи**. Они ставятся в очередь микрозадач (microtask queue) и выполняются после того, как стек вызовов будет пуст, но до перехода к следующему циклу Event Loop.
4. **Ввод-вывод (I/O)**: Операции с внешними системами, такие как запросы к сети или базам данных, обрабатываются в фазах **I/O Callbacks** и **Poll**.

## Пример работы с асинхронностью в Node.js

```javascript
console.log("Start")

setTimeout(() => {
  console.log("setTimeout")
}, 0)

fs.readFile(__filename, () => {
  console.log("File read complete")
})

Promise.resolve().then(() => {
  console.log("Promise resolved")
})

console.log("End")
```

**Результат:**

```
Start
End
Promise resolved
File read complete
setTimeout
```

### Объяснение порядка выполнения:

- Сначала выполняется синхронный код (`console.log("Start")` и `console.log("End")`).
- Промис (`Promise.resolve().then()`) ставится в очередь микрозадач и выполняется сразу после синхронного кода.
- Операция чтения файла (асинхронная) добавляется в очередь **I/O Callbacks**.
- Таймер `setTimeout` с 0 задержкой добавляется в очередь **Timers** и выполняется после выполнения всех микрозадач и I/O операций.

## Вывод

Node.js использует **Event Loop** для асинхронной обработки операций. Все операции, такие как I/O, таймеры и промисы, обрабатываются по очереди в разных фазах Event Loop, что позволяет Node.js эффективно и не блокируя выполнять множество операций одновременно.

---

[[002 Node.js|Назад]]
