---
title: Как обработать ошибки при работе с WebSocket
draft: false
tags:
  - "#NodeJS"
  - "#WebSocket"
  - "#обработка-ошибок"
  - "#ws"
  - "#сеть"
  - "#real-time"
info:
  - "[Документация библиотеки ws для Node.js](https://github.com/websockets/ws/blob/master/doc/ws.md)"
  - "[Спецификация WebSocket API](https://developer.mozilla.org/ru/docs/Web/API/WebSockets_API)"
  - "[Руководство по обработке ошибок в Node.js](https://nodejs.org/en/learn/error-handling/error-handling-best-practices)"
---

Ошибки при работе с WebSocket-соединениями могут возникать как на стороне клиента, так и на стороне сервера. Обработка ошибок критична для того, чтобы предотвратить сбои в приложении, корректно завершить соединения и информировать пользователя о проблемах.

### 1. **Обработка ошибок на сервере (с использованием `ws` в Node.js)**

На серверной стороне ошибки могут быть связаны с проблемами соединения, передачи сообщений или внутренними ошибками WebSocket-сервера. В библиотеке `ws` можно использовать события `error` и `close` для обработки ошибок.

#### Пример:

```javascript
const WebSocket = require("ws")

const wss = new WebSocket.Server({ port: 8080 })

wss.on("connection", (ws) => {
  console.log("Клиент подключен")

  ws.on("message", (message) => {
    console.log("Получено сообщение: %s", message)
  })

  // Обработка ошибок на уровне конкретного соединения
  ws.on("error", (error) => {
    console.error("Ошибка WebSocket-соединения:", error)
  })

  // Закрытие соединения
  ws.on("close", (code, reason) => {
    console.log(`Соединение закрыто. Код: ${code}, причина: ${reason}`)
  })
})

// Обработка ошибок сервера
wss.on("error", (error) => {
  console.error("Ошибка WebSocket-сервера:", error)
})
```

### 2. **Обработка ошибок на клиенте (с использованием WebSocket API)**

На клиентской стороне ошибки могут быть связаны с проблемами подключения или передачей данных. В WebSocket API можно обработать ошибки с помощью события `error` и события закрытия соединения `close`.

#### Пример:

```javascript
const ws = new WebSocket("ws://localhost:8080")

// Обработка ошибок при установке соединения
ws.onerror = (error) => {
  console.error("Ошибка WebSocket:", error)
}

// Обработка сообщений от сервера
ws.onmessage = (event) => {
  console.log("Сообщение от сервера:", event.data)
}

// Обработка закрытия соединения
ws.onclose = (event) => {
  if (event.wasClean) {
    console.log(`Соединение закрыто чисто. Код: ${event.code}, причина: ${event.reason}`)
  } else {
    console.error(`Ошибка соединения: ${event.code}`)
  }
}

// Отправка сообщений на сервер
ws.onopen = () => {
  ws.send("Привет, сервер!")
}
```

### 3. **Обработка ошибок при передаче сообщений**

Ошибки могут возникать и при передаче данных через WebSocket. Например, если клиент пытается отправить сообщение, но соединение закрыто. В таких случаях необходимо проверять состояние соединения перед отправкой сообщений.

#### Пример проверки перед отправкой:

```javascript
if (ws.readyState === WebSocket.OPEN) {
  ws.send("Сообщение")
} else {
  console.error("WebSocket соединение не открыто. Не могу отправить сообщение")
}
```

### 4. **Обработка ошибок при установке соединения (например, с использованием библиотеки `ws`)**

Ошибка может возникнуть при попытке установить соединение. Это может произойти, если сервер недоступен или если есть проблемы с сетью.

#### Пример:

```javascript
const ws = new WebSocket("ws://localhost:8080")

ws.on("open", () => {
  console.log("Соединение установлено")
})

ws.on("error", (error) => {
  console.error("Не удалось установить соединение:", error)
})
```

### 5. **Реализация повторных попыток при ошибке соединения**

Если соединение не удаётся установить (например, сервер не доступен), можно реализовать механизм повторных попыток.

#### Пример с использованием библиотеки `ws` и повторных попыток:

```javascript
const WebSocket = require("ws")
const MAX_RETRIES = 5
let retries = 0

function createConnection() {
  const ws = new WebSocket("ws://localhost:8080")

  ws.on("open", () => {
    console.log("Соединение установлено")
    retries = 0 // сбрасываем количество попыток при успешном соединении
  })

  ws.on("error", (error) => {
    console.error("Ошибка соединения:", error)
    if (retries < MAX_RETRIES) {
      retries++
      console.log(`Попытка №${retries} повторного подключения...`)
      setTimeout(createConnection, 1000 * retries) // задержка перед следующей попыткой
    } else {
      console.log("Максимальное количество попыток подключения исчерпано")
    }
  })
}

createConnection()
```

### 6. **Обработка ошибок при несоответствии формата данных**

При передаче данных через WebSocket важно убедиться, что сообщения соответствуют ожидаемому формату. Например, можно обрабатывать ошибки при получении неверных данных.

#### Пример:

```javascript
ws.on("message", (message) => {
  try {
    const data = JSON.parse(message)
    console.log("Данные:", data)
  } catch (error) {
    console.error("Ошибка парсинга сообщения:", error)
  }
})
```

### Заключение

Обработка ошибок в WebSocket-соединениях — важная часть разработки надежных приложений в реальном времени. Для эффективной обработки ошибок используйте:

- Событие `error` для обнаружения ошибок на соединении.
- Событие `close` для отслеживания закрытия соединения.
- Проверку состояния соединения перед отправкой сообщений.
- Реализацию повторных попыток при ошибках соединения.

Правильная обработка ошибок обеспечит стабильную работу вашего WebSocket-сервера и клиентов.

---

[[002 Node.js|Назад]]
