---
title: Как загрузить модуль из строки (динамически) без файла
draft: false
tags:
  - "#NodeJS"
  - "#vm"
  - "#модули"
  - "#динамическая_загрузка"
  - "#безопасность"
info:
  - https://nodejs.org/api/vm.html
  - https://www.npmjs.com/package/require-from-string
---

В Node.js можно динамически загружать модули из строки, используя несколько подходов. Это может быть полезно для плагинов, тестирования или выполнения кода, полученного динамически во время выполнения программы.

## 1. Использование встроенного модуля `vm`

Наиболее распространенный подход — использование встроенного модуля **`vm`** (Virtual Machine), который позволяет выполнять JavaScript код в изолированном контексте.

### Пример с модулем `vm`:

```javascript
const vm = require("vm")

// Код модуля в виде строки
const code = `
  module.exports = function() {
    return 'Hello from dynamic module!';
  };
`

// Создаем контекст выполнения
const context = { module: {}, exports: {} }

// Выполняем код в изолированном контексте
vm.runInNewContext(code, context)

// Получаем экспортированный модуль
const dynamicModule = context.module.exports

// Используем динамически загруженный модуль
console.log(dynamicModule()) // 'Hello from dynamic module!'
```

### Как это работает:

1. Создаем строку `code` с кодом модуля
2. Создаем контекст `context` с объектами `module` и `exports` для имитации окружения модуля
3. Выполняем код в изолированном контексте с помощью `vm.runInNewContext()`
4. Получаем доступ к экспортированным данным через `context.module.exports` или `context.exports`

## 2. Использование пакета `require-from-string`

Для упрощения динамической загрузки можно использовать сторонний пакет **`require-from-string`**.

### Установка пакета:

```bash
npm install require-from-string
```

### Пример использования:

```javascript
const requireFromString = require("require-from-string")

// Код модуля в виде строки
const code = `
  module.exports = function() {
    return 'Hello from dynamic module!';
  };
`

// Загружаем модуль из строки
const dynamicModule = requireFromString(code)

// Используем модуль
console.log(dynamicModule()) // 'Hello from dynamic module!'
```

Этот подход проще в использовании, так как под капотом пакет сам настраивает контекст и выполняет код через `vm` модуль.

## 3. Загрузка модуля с зависимостями

Если динамический модуль требует доступа к другим модулям, можно передать `require` в контекст:

```javascript
const vm = require("vm")

// Код модуля, использующий внешнюю библиотеку
const code = `
  const _ = require('lodash');
  
  module.exports = function() {
    return _.join(['Hello', 'from', 'dynamic', 'module'], ' ');
  };
`

// Контекст с доступом к require
const context = {
  module: {},
  exports: {},
  require: require, // Предоставляем доступ к require
}

// Выполняем код
vm.runInNewContext(code, context)

// Используем модуль
console.log(context.module.exports()) // 'Hello from dynamic module'
```

## 4. Использование с eval() (не рекомендуется)

В некоторых случаях можно использовать `eval()`, но это **крайне не рекомендуется** из-за серьезных проблем с безопасностью:

```javascript
// НЕ РЕКОМЕНДУЕТСЯ!
const moduleExports = {}
const moduleObj = { exports: moduleExports }

eval(`
  (function(module, exports) {
    exports.hello = function() { 
      return 'Hello dynamically!'; 
    };
  })(moduleObj, moduleExports);
`)

console.log(moduleObj.exports.hello()) // 'Hello dynamically!'
```

## Важные замечания по безопасности

1. **Риски безопасности**: Динамическая загрузка кода из строки может быть опасной, особенно если код получен из ненадежных источников. Всегда проверяйте содержимое строки перед её выполнением.

2. **Изоляция**: Модуль `vm` предоставляет некоторую изоляцию, но она не является полной. Код в изолированном контексте все еще может иметь доступ к определенным глобальным объектам.

3. **Права доступа**: Если вы передаете `require` в контекст, динамический код получает доступ ко всей файловой системе и может загружать любые модули.

4. **Производительность**: Динамическая загрузка модулей из строки менее эффективна, чем обычная загрузка модулей через require, особенно при частом использовании.

## Практические применения

- Разработка систем плагинов
- Реализация расширений без перезапуска приложения
- Выполнение динамически сгенерированного кода
- Тестирование отдельных модулей с моковыми зависимостями

---

[[002 Node.js|Назад]]
