---
title: Какие события существуют у WebSocket-соединения и для чего они используются
draft: false
tags:
  - "#NodeJS"
  - "#WebSocket"
  - "#события"
  - "#сеть"
  - "#real-time"
  - "#ws"
info:
  - "[Документация библиотеки ws](https://github.com/websockets/ws/blob/master/doc/ws.md)"
  - "[MDN WebSocket API](https://developer.mozilla.org/ru/docs/Web/API/WebSockets_API)"
  - "[Руководство по WebSocket в Node.js](https://www.npmjs.com/package/ws#usage-examples)"
---

# События WebSocket-соединения в Node.js

У WebSocket-соединения в Node.js, использующего библиотеку **`ws`**, существует несколько основных событий, которые помогают отслеживать различные этапы жизненного цикла соединения. Эти события позволяют эффективно управлять WebSocket-соединениями и обрабатывать получаемые данные.

## Основные события WebSocket

### 1. **`open`**

**Описание**: Срабатывает, когда WebSocket-соединение успешно установлено с сервером.

**Использование**: Используется для выполнения операций после установления соединения, например, отправки первоначальных сообщений на сервер.

```javascript
ws.on("open", () => {
  console.log("Соединение установлено")
})
```

### 2. **`message`**

**Описание**: Срабатывает, когда WebSocket-соединение получает сообщение от сервера (или клиента, в зависимости от направления).

**Использование**: Используется для обработки данных, полученных через WebSocket.

```javascript
ws.on("message", (data) => {
  console.log("Получено сообщение:", data)
})
```

### 3. **`error`**

**Описание**: Срабатывает при ошибках, связанных с соединением WebSocket.

**Использование**: Помогает отлавливать и обрабатывать ошибки, такие как проблемы с сетью, сервером или неправильные данные.

```javascript
ws.on("error", (err) => {
  console.error("Ошибка WebSocket:", err)
})
```

### 4. **`close`**

**Описание**: Срабатывает, когда соединение закрывается. Это может происходить как по инициативе клиента, так и сервера.

**Использование**: Используется для выполнения операций при закрытии соединения, таких как очистка ресурсов или уведомление об отключении.

```javascript
ws.on("close", () => {
  console.log("Соединение закрыто")
})
```

## Дополнительные события для проверки жизнеспособности

### 5. **`ping`**

**Описание**: Срабатывает, когда сервер посылает **ping**-сообщение для проверки состояния соединения.

**Использование**: В большинстве случаев обработка этого события не требуется, так как библиотека **`ws`** автоматически отвечает на **ping** сообщением **pong**. Однако можно настроить обработчик, если нужно вручную обрабатывать такие события.

```javascript
ws.on("ping", () => {
  console.log("Получен ping-сигнал от сервера")
})
```

### 6. **`pong`**

**Описание**: Срабатывает, когда сервер или клиент получает **pong**-ответ на своё **ping**-сообщение.

**Использование**: Обычно используется для управления активностью соединения и проверки живости. В большинстве случаев не требуется вручную обрабатывать это событие, так как библиотека **`ws`** автоматически отвечает на **ping**-сигнал.

```javascript
ws.on("pong", () => {
  console.log("Получен pong-сигнал")
})
```

## Полный пример использования событий WebSocket

```javascript
const WebSocket = require("ws")

// Создание WebSocket-сервера
const wss = new WebSocket.Server({ port: 8080 })

wss.on("connection", (ws) => {
  console.log("Новое соединение установлено")

  ws.on("open", () => {
    console.log("Соединение открыто")
  })

  ws.on("message", (message) => {
    console.log("Получено сообщение:", message)
  })

  ws.on("error", (err) => {
    console.error("Ошибка WebSocket:", err)
  })

  ws.on("close", () => {
    console.log("Соединение закрыто")
  })

  // Отправка сообщения клиенту
  ws.send("Привет, клиент!")
})
```

## Пример реализации периодической проверки соединения

```javascript
const WebSocket = require("ws")
const wss = new WebSocket.Server({ port: 8080 })

function heartbeat() {
  this.isAlive = true
}

wss.on("connection", (ws) => {
  ws.isAlive = true
  ws.on("pong", heartbeat)

  // Обработка сообщений и других событий...
})

// Проверка активных соединений каждые 30 секунд
const interval = setInterval(() => {
  wss.clients.forEach((ws) => {
    if (ws.isAlive === false) return ws.terminate()

    ws.isAlive = false
    ws.ping()
  })
}, 30000)

// Очистка интервала при закрытии сервера
wss.on("close", () => {
  clearInterval(interval)
})
```

## Резюме

Основные события WebSocket помогают эффективно управлять соединениями:

- **`open`** — сигнал о начале соединения
- **`message`** — получение данных от клиента/сервера
- **`error`** — обработка ошибок соединения
- **`close`** — сигнал о закрытии соединения
- **`ping`/`pong`** — поддержание активности соединения

Правильная обработка этих событий позволяет создавать надежные приложения реального времени, способные адекватно реагировать на изменения состояния соединения и обеспечивать бесперебойную передачу данных между клиентом и сервером.

---

[[002 Node.js|Назад]]
