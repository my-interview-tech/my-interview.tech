---
title: Что такое npm ci и чем она отличается от npm install
draft: false
tags:
  - "#NodeJS"
  - "#npm"
  - "#CI"
  - "#DevOps"
  - "#зависимости"
  - "#package-lock"
info:
  - "[Официальная документация npm ci](https://docs.npmjs.com/cli/v8/commands/npm-ci)"
  - "[Блог npm о команде ci](https://blog.npmjs.org/post/171556855892/introducing-npm-ci-for-faster-more-reliable)"
  - "[Руководство по npm-скриптам](https://docs.npmjs.com/cli/v8/using-npm/scripts)"
---

**npm ci** (clean install) — это команда, введенная в npm 5.7.0, предназначенная для установки зависимостей проекта в автоматизированных средах, таких как системы непрерывной интеграции (CI/CD), тестовые платформы и развертывания.

## Основные различия между npm ci и npm install

| **Параметр**                     | **npm ci**                                        | **npm install**                              |
| -------------------------------- | ------------------------------------------------- | -------------------------------------------- |
| **Файл блокировки**              | Требует package-lock.json или npm-shrinkwrap.json | Может работать без файла блокировки          |
| **Модификация файлов**           | Никогда не изменяет package.json или lock-файл    | Может обновлять package-lock.json            |
| **Существующие node_modules**    | Полностью удаляет перед установкой                | Обновляет существующую директорию            |
| **Отсутствующие зависимости**    | Выдает ошибку при несоответствии                  | Обновляет package-lock.json для соответствия |
| **Скорость на чистой установке** | Обычно быстрее                                    | Обычно медленнее                             |
| **Кеширование пакетов**          | Использует кеш, но не обновляет его               | Использует и обновляет кеш                   |

## Преимущества npm ci

### 1. Воспроизводимость сборок

`npm ci` гарантирует, что все установленные зависимости точно соответствуют версиям, указанным в `package-lock.json`, что обеспечивает одинаковые сборки в разных средах и на разных машинах.

### 2. Повышенная надежность

Команда работает более детерминированно, чем `npm install`, так как никогда не модифицирует package.json или package-lock.json, что снижает риск неожиданного поведения.

### 3. Ускорение установки

В CI-средах `npm ci` обычно работает быстрее, чем `npm install`, особенно для проектов с большим количеством зависимостей, так как:

- Не требуется генерация дерева зависимостей (оно берется из package-lock.json)
- Оптимизирована для чистой установки без анализа существующих пакетов
- Установка выполняется строго последовательно, а не параллельно

### 4. Предотвращение случайных изменений

`npm ci` выдает ошибку, если package.json и package-lock.json не синхронизированы, что помогает обнаруживать проблемы раньше в процессе разработки.

## Когда использовать npm ci

### 1. В системах CI/CD

Идеально подходит для сред непрерывной интеграции и доставки:

```bash
# В файле .gitlab-ci.yml
script:
  - npm ci
  - npm test
```

### 2. При развертывании в продакшн

Для обеспечения точной установки зависимостей при развертывании:

```bash
# В скрипте развертывания
npm ci --production
npm run build
```

### 3. При необходимости чистой установки

Когда нужно полностью пересоздать node_modules без изменения файлов блокировки:

```bash
# Для решения проблем с зависимостями
rm -rf node_modules
npm ci
```

## Ограничения npm ci

1. **Требует package-lock.json**: не может работать без файла блокировки
2. **Менее гибкая**: не подходит для разработки, где требуется обновление зависимостей
3. **Нет поддержки глобальной установки**: работает только для локальных проектов

## Примеры использования

### Базовое использование

```bash
# Установка всех зависимостей согласно package-lock.json
npm ci
```

### Установка только production-зависимостей

```bash
# Пропуск devDependencies
npm ci --production
```

### Интеграция с CI/CD системами

```yaml
# GitHub Actions workflow
name: Node.js CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: "16"
          cache: "npm"
      - run: npm ci
      - run: npm test
```

### Добавление в NPM-скрипты

```json
// package.json
{
  "scripts": {
    "test": "jest",
    "clean-install": "rm -rf node_modules && npm ci",
    "prepare-prod": "npm ci --production && npm run build"
  }
}
```

## Лучшие практики

1. **Используйте npm ci в CI/CD-пайплайнах** вместо npm install
2. **Включайте package-lock.json в систему контроля версий**
3. **Используйте npm install в процессе разработки** и `npm ci` для чистой установки
4. **Регулярно обновляйте зависимости** с помощью `npm update` и затем коммитьте обновленный package-lock.json

## Заключение

Команда `npm ci` — это важный инструмент для современных JavaScript-проектов, обеспечивающий надежность и воспроизводимость сборок, особенно в командной разработке и при автоматизированном тестировании/развертывании. Правильное сочетание `npm install` для разработки и `npm ci` для развертывания помогает создать более надежный процесс разработки и доставки программного обеспечения.

---

[[003 JSCore|Назад]]
