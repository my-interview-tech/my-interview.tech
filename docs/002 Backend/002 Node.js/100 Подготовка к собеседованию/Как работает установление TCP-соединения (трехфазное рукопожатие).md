---
title: Как работает установление TCP-соединения (трехфазное рукопожатие)
draft: false
tags:
  - "#NodeJS"
  - "#сети"
  - "#TCP"
  - "#трехфазное_рукопожатие"
  - "#сокеты"
info:
  - "[Документация по протоколу TCP RFC 793](https://tools.ietf.org/html/rfc793)"
  - "[Трехфазное рукопожатие в сетях TCP/IP](https://www.geeksforgeeks.org/tcp-3-way-handshake-process/)"
  - "[Networking in Node.js](https://nodejs.org/docs/latest/api/net.html)"
---

Трехфазное рукопожатие (Three-way handshake) — это процесс установления соединения между клиентом и сервером в протоколе TCP (Transmission Control Protocol). Этот механизм гарантирует, что обе стороны готовы к передаче данных и согласовали начальные параметры соединения, такие как порядковые номера пакетов.

## Основные флаги TCP, используемые при рукопожатии

Перед объяснением самого процесса, познакомимся с основными флагами TCP-пакетов:

- **SYN (Synchronize)** — используется для инициирования соединения и синхронизации порядковых номеров
- **ACK (Acknowledgment)** — используется для подтверждения успешного получения пакетов
- **FIN (Finish)** — сигнализирует о завершении передачи данных
- **RST (Reset)** — сбрасывает соединение при возникновении ошибок
- **PSH (Push)** — указывает, что данные должны быть переданы приложению немедленно
- **URG (Urgent)** — указывает на наличие срочных данных

## Процесс трехфазного рукопожатия

Трехфазное рукопожатие (Three-way handshake) состоит из трех этапов:

### 1. SYN: Клиент отправляет запрос на соединение

Клиент отправляет TCP-пакет с установленным флагом **SYN** на сервер:

```
Клиент → Сервер: SYN, SEQ=x
```

Где:

- **SYN** — флаг синхронизации (установлен в 1)
- **SEQ=x** — начальный порядковый номер клиента (случайное число)

На этом этапе клиент переходит в состояние **SYN-SENT**.

### 2. SYN-ACK: Сервер подтверждает запрос

Сервер получает SYN-пакет, создает запись о будущем соединении и отвечает пакетом с установленными флагами **SYN** и **ACK**:

```
Сервер → Клиент: SYN, ACK, SEQ=y, ACK=x+1
```

Где:

- **SYN** — флаг синхронизации (установлен в 1)
- **ACK** — флаг подтверждения (установлен в 1)
- **SEQ=y** — начальный порядковый номер сервера (другое случайное число)
- **ACK=x+1** — подтверждение получения SYN от клиента (следующий ожидаемый байт)

На этом этапе сервер переходит в состояние **SYN-RECEIVED**.

### 3. ACK: Клиент подтверждает ответ сервера

Клиент отправляет последний пакет с установленным флагом **ACK**:

```
Клиент → Сервер: ACK, SEQ=x+1, ACK=y+1
```

Где:

- **ACK** — флаг подтверждения (установлен в 1)
- **SEQ=x+1** — следующий порядковый номер клиента
- **ACK=y+1** — подтверждение получения SYN от сервера (следующий ожидаемый байт)

На этом этапе соединение считается **установленным**. Клиент переходит в состояние **ESTABLISHED**, а сервер, получив последний ACK, также переходит в состояние **ESTABLISHED**.

## Визуальное представление

```
Клиент                   Сервер
   |                        |
   |------- SYN, SEQ=x ---->|
   |                        |
   |<-- SYN, ACK, SEQ=y ----|
   |      ACK=x+1           |
   |                        |
   |---- ACK, SEQ=x+1 ----->|
   |      ACK=y+1           |
   |                        |
   |--------- данные ------>|
   |<-------- данные -------|
   |                        |
```

## Зачем нужно трехфазное рукопожатие?

Трехфазное рукопожатие решает несколько важных задач:

1. **Синхронизация порядковых номеров** — обе стороны знают, с какого номера начинать отслеживание пакетов
2. **Подтверждение двусторонней связи** — убеждается, что связь работает в обоих направлениях
3. **Защита от устаревших соединений** — предотвращает установление соединений по устаревшим запросам
4. **Согласование параметров** — стороны могут согласовать параметры соединения (размер окна, опции TCP)

## Значение для Node.js

В Node.js TCP-соединения используются в различных модулях, включая:

- **net** — базовый модуль для создания TCP-серверов и клиентов
- **http/https** — для веб-серверов и клиентов (поверх TCP)
- **databases** — подключения к базам данных часто используют TCP

Пример установления TCP-соединения в Node.js:

```javascript
const net = require("net")

// TCP-сервер
const server = net.createServer((socket) => {
  console.log("Клиент подключен")
  socket.write("Привет, клиент!")

  socket.on("data", (data) => {
    console.log(`Получено: ${data}`)
  })
})

server.listen(3000, () => {
  console.log("Сервер слушает порт 3000")
})

// TCP-клиент
const client = net.createConnection({ port: 3000 }, () => {
  console.log("Подключено к серверу")
  client.write("Привет, сервер!")
})

client.on("data", (data) => {
  console.log(`Получено от сервера: ${data}`)
})
```

При выполнении этого кода, Node.js использует протокол TCP, который автоматически выполняет трехфазное рукопожатие для установления соединения.

## Возможные проблемы с TCP-рукопожатием

1. **SYN-флуд атаки** — злоумышленник отправляет множество SYN-пакетов без завершения рукопожатия
2. **Брандмауэры и NAT** — могут блокировать или модифицировать TCP-пакеты
3. **Высокая задержка сети** — может привести к тайм-аутам во время рукопожатия
4. **Потеря пакетов** — требует повторной отправки и увеличивает время установления соединения

---

[[002 Node.js|Назад]]
