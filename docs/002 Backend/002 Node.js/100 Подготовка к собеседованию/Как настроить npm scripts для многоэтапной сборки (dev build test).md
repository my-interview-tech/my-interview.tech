---
title: Как настроить npm scripts для многоэтапной сборки (dev build test)
draft: false
tags:
  - "#NodeJS"
  - "#npm"
  - "#сборка"
  - "#scripts"
  - "#webpack"
  - "#автоматизация"
info:
  - "[Документация npm по скриптам](https://docs.npmjs.com/cli/v8/using-npm/scripts)"
  - "[Руководство по npm scripts](https://docs.npmjs.com/cli/v8/commands/npm-run-script)"
  - "[Документация по webpack](https://webpack.js.org/concepts/)"
---

Для настройки многоэтапной сборки с использованием **npm scripts** можно создать серию шагов, которые будут запускаться поочередно: **`dev`**, **`build`**, **`test`** и другие. Эти шаги могут включать сборку, тестирование, разработку и прочее. Давайте рассмотрим, как это можно организовать.

### 1. Создание базовых скриптов в **`package.json`**:

```json
{
  "name": "my-project",
  "version": "1.0.0",
  "scripts": {
    "dev": "webpack serve --mode development", // Запуск разработки
    "build": "webpack --mode production", // Сборка для продакшн
    "test": "jest", // Запуск тестов
    "start": "npm run dev", // Сценарий для запуска разработки
    "prebuild": "npm run test", // Запуск тестов перед сборкой
    "postbuild": "npm run deploy", // Развертывание после сборки
    "deploy": "echo 'Deploying project...'" // Развертывание (заглушка для примера)
  },
  "devDependencies": {
    "webpack": "^5.0.0",
    "webpack-cli": "^4.0.0",
    "webpack-dev-server": "^4.0.0",
    "jest": "^27.0.0"
  },
  "dependencies": {
    "react": "^17.0.0"
  }
}
```

### 2. Объяснение каждого скрипта:

- **`dev`**: Этот скрипт запускает **Webpack Dev Server** в режиме разработки. Он будет слушать изменения в коде и обновлять сборку автоматически при изменениях.
- **`build`**: Этот скрипт выполняет сборку проекта для продакшн-среды с помощью **Webpack** в режиме продакшн. Сюда можно добавить оптимизации, минификацию и другие улучшения.
- **`test`**: Запуск тестов с помощью **Jest** (или любого другого тестового фреймворка). Этот скрипт может проверять ваш код на наличие ошибок или запускать тесты для проверки корректности работы приложения.
- **`start`**: Это вспомогательный скрипт для простоты, который просто запускает режим разработки, аналогично `npm run dev`.
- **`prebuild`**: Этот скрипт выполняется перед запуском основного **`build`**. В данном примере он запускает тесты перед сборкой. Если тесты не проходят, сборка не будет выполнена.
- **`postbuild`**: Этот скрипт выполняется после основной сборки. В примере используется заглушка **`deploy`**, но на практике здесь можно разместить код для развертывания проекта, деплоя в облако и т. д.

### 3. Последовательность выполнения скриптов:

- **`npm run prebuild`** — запускает тесты с помощью **`npm run test`**.
- Если тесты проходят успешно, то выполняется **`npm run build`**.
- После успешной сборки выполняется **`npm run postbuild`**, что может быть использовано для деплоя или других постобработок.

### 4. Добавление скриптов для многоэтапной сборки:

Если у вас несколько этапов в сборке (например, сборка различных частей приложения), можно комбинировать их с помощью зависимостей:

```json
{
  "scripts": {
    "dev": "webpack serve --mode development",
    "build:css": "postcss src/styles.css -o dist/styles.css", // Пример сборки CSS
    "build:js": "webpack --mode production", // Сборка JS
    "build": "npm run build:css && npm run build:js", // Сборка всех файлов
    "test": "jest",
    "deploy": "echo 'Deploying project...'",
    "start": "npm run dev",
    "prebuild": "npm run test", // Тестирование перед сборкой
    "postbuild": "npm run deploy" // Развертывание после сборки
  }
}
```

- **`build:css`** и **`build:js`** — это два отдельных этапа сборки для CSS и JavaScript.
- **`build`** теперь является комбинированным скриптом, который сначала запускает сборку CSS, а затем сборку JS.

### 5. Использование параллельных задач:

Для параллельного выполнения задач можно использовать такие инструменты, как **`concurrently`** или **`npm-run-all`**. Это позволяет ускорить процесс, выполняя несколько задач одновременно.

Пример с **`concurrently`**:

```json
{
  "scripts": {
    "dev": "concurrently \"webpack serve --mode development\" \"npm run start:watch\"",
    "start:watch": "webpack --watch",
    "build": "npm run build:css && npm run build:js",
    "test": "jest"
  }
}
```

Теперь, при запуске **`npm run dev`**, одновременно будут выполняться две задачи: сборка с **webpack** и отслеживание изменений через **`start:watch`**.

### Заключение:

Настройка многоэтапной сборки с помощью **npm scripts** предоставляет гибкость и контроль над процессами, такими как сборка, тестирование, и развертывание. Использование **`prebuild`**, **`postbuild`**, **`npm-run-all`**, или **`concurrently`** позволяет легко управлять и автоматизировать различные шаги сборки и деплоя.

---

[[002 Node.js|Назад]]
