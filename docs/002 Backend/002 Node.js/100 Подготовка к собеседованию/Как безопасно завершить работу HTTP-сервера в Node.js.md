---
title: Как безопасно завершить работу HTTP-сервера в Node.js
draft: false
tags:
  - "#NodeJS"
  - "#HTTP"
  - "#process"
  - "#server"
  - "#сигналы"
  - "#graceful_shutdown"
info:
  - https://nodejs.org/api/http.html#serverclose
  - https://nodejs.org/api/process.html#signal-events
---

Чтобы безопасно завершить работу HTTP-сервера в Node.js, важно корректно завершить все активные соединения и выполнить необходимые финальные операции, такие как закрытие базы данных или файловых потоков. Для этого можно обработать сигналы завершения процесса и правильно управлять состоянием сервера.

Вот шаги, которые помогут безопасно завершить HTTP-сервер в Node.js:

### 1. Обработать сигналы завершения (например, `SIGINT` и `SIGTERM`)

Для корректного завершения работы сервера необходимо перехватить сигналы, такие как **`SIGINT`** (например, при нажатии Ctrl+C в терминале) и **`SIGTERM`** (для корректного завершения процесса) и завершить все активные соединения.

### 2. Остановить новый прием подключений

Когда сервер завершает работу, важно предотвратить принятие новых запросов. Для этого можно закрыть сервер на уровне HTTP, но оставить возможность завершить обработку уже активных запросов.

### 3. Закрыть открытые соединения

Нужно подождать, пока все текущие соединения завершат обработку, и только после этого завершить работу приложения.

### Пример безопасного завершения HTTP-сервера:

```javascript
const http = require("http")

// Создание HTTP-сервера
const server = http.createServer((req, res) => {
  res.end("Hello, world!")
})

// Запуск сервера
server.listen(3000, () => {
  console.log("Server is running on port 3000")
})

// Обработка сигнала SIGINT (например, Ctrl+C)
process.on("SIGINT", () => {
  console.log("Received SIGINT, shutting down gracefully...")

  // Остановить сервер от принятия новых соединений
  server.close(() => {
    console.log("HTTP server stopped accepting new connections.")

    // Завершаем все активные соединения
    process.exit(0) // Завершаем процесс с кодом 0 (успех)
  })

  // Даем время завершить текущие запросы (например, 10 секунд)
  setTimeout(() => {
    console.log("Force shutdown due to timeout")
    process.exit(1) // Завершаем процесс с кодом 1 (ошибка)
  }, 10000)
})

// Обработка сигнала SIGTERM (например, при завершении через операционную систему)
process.on("SIGTERM", () => {
  console.log("Received SIGTERM, shutting down gracefully...")

  // Останавливаем сервер, не принимаем новые соединения
  server.close(() => {
    console.log("HTTP server stopped accepting new connections.")

    // Завершаем процесс
    process.exit(0) // Завершаем процесс с кодом 0 (успех)
  })
})
```

### Ключевые шаги в коде:

1. **`server.close()`**: Этот метод используется для того, чтобы HTTP-сервер больше не принимал новые соединения. Он завершает работу, когда все текущие соединения будут обработаны.
2. **`process.on('SIGINT')` и `process.on('SIGTERM')`**: Эти обработчики событий перехватывают сигналы завершения и вызывают процесс завершения работы сервера.
3. **`setTimeout`**: Если сервер не успевает завершить обработку всех запросов (например, они зависли), можно задать тайм-аут, чтобы принудительно завершить процесс через определенное время.

### Почему важно завершать сервер корректно:

- **Освобождение ресурсов**: Закрытие открытых соединений и завершение асинхронных операций (например, сохранение данных в базе данных) поможет избежать утечек ресурсов.
- **Предотвращение потери данных**: Даем время для корректного завершения запросов, чтобы избежать потери данных (например, при записи в базу данных).
- **Нормальное завершение**: Корректное завершение работы помогает убедиться, что приложение не завершится с ошибками, и его можно будет безопасно перезапустить.

### Важные моменты:

- **Дайте достаточно времени для завершения**: Если сервер не завершает соединения в пределах нормального времени, используйте тайм-аут для принудительного завершения.
- **Отслеживайте открытые соединения**: Убедитесь, что все открытые соединения (например, с базой данных) также закрыты, чтобы избежать утечек ресурсов.

---

[[002 Node.js|Назад]]
