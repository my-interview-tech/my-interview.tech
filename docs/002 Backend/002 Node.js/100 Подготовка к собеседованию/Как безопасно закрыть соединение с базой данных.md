---
title: Как безопасно закрыть соединение с базой данных
draft: false
tags:
  - "#NodeJS"
  - "#database"
  - "#mysql"
  - "#connection"
  - "#resource_management"
info:
  - https://github.com/sidorares/node-mysql2#using-connection-pools
  - https://nodejs.org/api/net.html#socketend
---

Закрывать соединение с базой данных нужно правильно, чтобы избежать утечек ресурсов и зависших процессов.

### **1. Закрытие обычного соединения**

Если используется `mysql2.createConnection()`, нужно вызвать `connection.end()`.

```javascript
const mysql = require("mysql2")

const connection = mysql.createConnection({
  host: "localhost",
  user: "root",
  password: "password",
  database: "test_db",
})

connection.connect((err) => {
  if (err) {
    console.error("Ошибка подключения:", err.message)
    return
  }
  console.log("Подключение успешно")

  // Закрываем соединение после выполнения запроса
  connection.query("SELECT * FROM users", (err, results) => {
    if (err) {
      console.error("Ошибка запроса:", err.message)
      return
    }
    console.log("Результат:", results)

    connection.end((err) => {
      if (err) {
        console.error("Ошибка закрытия соединения:", err.message)
      } else {
        console.log("Соединение закрыто")
      }
    })
  })
})
```

#### **Как это работает**:

1. Создаем соединение.
2. Выполняем запрос.
3. Закрываем соединение вызовом `connection.end()`.
4. Проверяем ошибки при закрытии.

### **2. Закрытие пула соединений**

Если используется `mysql2.createPool()`, закрывать нужно **весь пул соединений** вызовом `pool.end()`.

```javascript
const mysql = require("mysql2")

const pool = mysql.createPool({
  host: "localhost",
  user: "root",
  password: "password",
  database: "test_db",
  waitForConnections: true,
  connectionLimit: 10,
})

pool.query("SELECT * FROM users", (err, results) => {
  if (err) {
    console.error("Ошибка запроса:", err.message)
    return
  }
  console.log("Результат:", results)

  // Закрываем пул соединений
  pool.end((err) => {
    if (err) {
      console.error("Ошибка закрытия пула:", err.message)
    } else {
      console.log("Пул соединений закрыт")
    }
  })
})
```

#### **Как это работает**:

- `pool.end()` **ждет завершения всех активных соединений** перед закрытием.
- Новый запрос после `pool.end()` выполнить **нельзя**.

### **3. Обработка ошибок при закрытии**

Если соединение было уже закрыто, повторный `end()` вызовет ошибку. Чтобы избежать этого, можно добавить проверку:

```javascript
if (connection.state !== "disconnected") {
  connection.end()
}
```

Для пула:

```javascript
if (pool._closed !== true) {
  pool.end()
}
```

### **Вывод**

- Используйте `connection.end()` для одиночного соединения.
- Используйте `pool.end()` для корректного закрытия пула.
- Проверяйте ошибки при закрытии соединения.
- `end()` следует вызывать только один раз.

---

[[002 Node.js|Назад]]
